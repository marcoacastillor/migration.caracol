BROKER SCHEMA co.com.caracol.integration.commos

CREATE PROCEDURE createMessageErrorSOAP(INOUT refOut REFERENCE)
BEGIN
	DECLARE s12 NAMESPACE 'http://www.w3.org/2003/05/soap-envelope';
	DECLARE eb NAMESPACE 'http://docs.oasis-open.org/ebxml-msg/ebms/v3.0/ns/core/200704/';
	DECLARE ns NAMESPACE 'http://www.w3.org/XML/1998/namespace';
	DECLARE csif NAMESPACE 'http://www.cysce.com/csif-msg/ca/fault/v1.0/';
		
	-----------------------------------
	-- Construir cabecera ebMS
	-----------------------------------
	-- MessageInfo
	CREATE FIELD refOut.XMLNSC.s12:Envelope.s12:Header.eb:Messaging.eb:MessageInfo TYPE Name;
	DECLARE rMessageInfo REFERENCE TO refOut.XMLNSC.s12:Envelope.s12:Header.eb:Messaging.eb:MessageInfo;
	-- Error
	CREATE FIELD refOut.XMLNSC.s12:Envelope.s12:Header.eb:Messaging.eb:ErrorList.eb:Error TYPE Name;
	DECLARE rError REFERENCE TO refOut.XMLNSC.s12:Envelope.s12:Header.eb:Messaging.eb:ErrorList.eb:Error;

			
	DECLARE targetFormat CHARACTER;
	SET targetFormat = 'yyyy-MM-dd''T''HH:mm:ss.SSSZZZ';
	
	SET rMessageInfo.eb:MessageId 						= COALESCE(Environment.Monitoring.EventCorrelation.localTransactionId,UUIDASCHAR);
	SET rMessageInfo.eb:Timestamp 						= CAST(InputRoot.Properties.CreationTime AS CHARACTER FORMAT targetFormat); --CAST(CURRENT_GMTTIMESTAMP AS CHARACTER FORMAT targetFormat);
--			SET rMessageInfo.eb:RefToMessageId 					= rUmMessageInfo.eb:MessageId;
			-- eb:Error/@origin (optional)
			SET rError.(XMLNSC.Attribute)origin 				= 'esb';
	-- eb:Error/@category (optional)
	SET rError.(XMLNSC.Attribute)category 				= '';
	-- eb:Error/@errorCode (required)
	SET rError.(XMLNSC.Attribute)errorCode 				= 1;
	-- eb:Error/@severity (required)
	SET rError.(XMLNSC.Attribute)severity 				= 'failure';
	-- eb:Error/@refToMessageInError (optional)
	SET rError.(XMLNSC.Attribute)refToMessageInError 	= '';
	-- eb:Error/@shortDescription (optional)
	SET rError.(XMLNSC.Attribute)shortDescription		= 'ERROR EN LA INVOCACION DEL SERVICIO DE BACKEND';
	-- eb:Error/Description (optional)
	SET rError.eb:Description.(XMLNSC.Attribute)ns:lang = 'en';
	SET rError.eb:Description 							= FIELDVALUE(InputRoot.SOAP.Body.soapenv:Fault.faultstring);
	-- eb:Error/ErrorDetail (optional)	
END;